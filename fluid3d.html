<!DOCTYPE HTML>
<html>
	<head>
		<title>Fluid3D - Unity WebGPU</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<link rel="stylesheet" href="assets/css/main.css" />
		<noscript><link rel="stylesheet" href="assets/css/noscript.css" /></noscript>
        
        <!-- Unity Style - Corrected Path -->
        <link rel="stylesheet" href="Fluid3D/TemplateData/style.css">
        
        <!-- 引入截图和二维码生成的库 (使用CDN) -->
        <script src="https://cdn.jsdelivr.net/npm/qrcodejs2@0.0.2/qrcode.min.js"></script>
        <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

        <style>
            /* Custom adjustments to fit Unity inside Forty theme */
            #unity-container {
                position: relative;
                width: 100%;
                max-width: 960px;
                margin: 2em auto;
                background: #232323;
            }
            canvas#unity-canvas {
                width: 100%;
                height: auto;
                aspect-ratio: 16/10;
            }

            /* 分享卡片的样式 (默认隐藏，仅用于生成图片) */
            #share-card-wrapper {
                position: fixed;
                top: -9999px;
                left: -9999px;
                z-index: -1;
            }

            #share-card {
                display: flex;
                flex-direction: row; /* 横向排列 */
                background-color: #242943; /* 保持网站主题色 */
                padding: 20px;
                align-items: center;
                width: 1200px; /* 固定宽度以保证生成质量 */
                border: 2px solid #9bf1ff;
            }

            .share-image-container {
                flex: 3;
                margin-right: 20px;
            }

            .share-image-container img {
                width: 100%;
                display: block;
                border: 1px solid rgba(255, 255, 255, 0.2);
            }

            .share-info-container {
                flex: 1;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                color: white;
                text-align: center;
            }

            .share-info-container h3 {
                margin-bottom: 10px;
                color: #9bf1ff;
            }

            #qrcode-container {
                background: white;
                padding: 10px;
                margin-top: 10px;
                border-radius: 4px;
            }
        </style>
	</head>
	<body class="is-preload">

		<!-- Wrapper -->
			<div id="wrapper">

				<!-- Header -->
					<header id="header" class="alt style2">
						<a href="index.html" class="logo"><strong>Graphics</strong> <span>by Hu Jinkun</span></a>
						<nav>
							<a href="#menu">Menu</a>
						</nav>
					</header>

				<!-- Menu -->
					<nav id="menu">
						<ul class="links">
							<li><a href="index.html">Home</a></li>
							<li><a href="fluid2d.html">2D Fluid</a></li>
							<li><a href="fluid3d.html">3D Fluid</a></li>
							<li><a href="fractals.html">Fractals</a></li>
							<li><a href="math_surfaces.html">Math Surfaces</a></li>
                            <li><a href="documents.html">Documents</a></li>
                            <li><a href="text_page.html">About</a></li>
						</ul>
                        <!-- 新增：截图分享按钮 -->
                        <ul class="actions stacked">
                            <li><a href="#" id="btn-share-screenshot" class="button primary fit">share</a></li>
                        </ul>
					</nav>

				<!-- Banner -->
					<section id="banner" class="style2">
						<div class="inner">
							<span class="image">
								<img src="images/pic07.jpg" alt="" />
							</span>
							<header class="major">
								<h1>Fluid3D</h1>
							</header>
							<div class="content">
								<p>Visualizing complex Fluid3D<br />
								using GPU-accelerated rendering.</p>
							</div>
						</div>
					</section>

				<!-- Main -->
					<div id="main">

						<!-- Content Section -->
							<section id="one">
								<div class="inner">
									<header class="major">
										<h2>Interactive 3D Fluid Sim</h2>
									</header>
									<p>P for play/pause, R for reset.</p>
									<p>S for slow modle, G for reversing gravity.</p>
									<p>Q or E for Rotating.</p>
                                    
                                    <!-- UNITY CONTAINER START -->
                                    <div id="unity-container" class="unity-desktop">
                                        <canvas id="unity-canvas" width=960 height=600 tabindex="-1"></canvas>
                                        <div id="unity-loading-bar">
                                          <div id="unity-logo"></div>
                                          <div id="unity-progress-bar-empty">
                                            <div id="unity-progress-bar-full"></div>
                                          </div>
                                        </div>
                                        <div id="unity-warning"> </div>
                                        <div id="unity-footer">
                                          <div id="unity-logo-title-footer"></div>
                                          <div id="unity-fullscreen-button"></div>
                                          <div id="unity-build-title">Web-End Demonstration</div>
                                        </div>
                                      </div>
                                    <!-- UNITY CONTAINER END -->

								</div>
							</section>
					</div>

				<!-- Contact -->
					<section id="contact">
						<div class="inner">
							<section>
								<form method="post" action="#">
									<div class="fields">
										<div class="field half">
											<label for="name">Name</label>
											<input type="text" name="name" id="name" />
										</div>
										<div class="field half">
											<label for="email">Email</label>
											<input type="text" name="email" id="email" />
										</div>
										<div class="field">
											<label for="message">Message</label>
											<textarea name="message" id="message" rows="6"></textarea>
										</div>
									</div>
									<ul class="actions">
										<li><input type="submit" value="Send Message" class="primary" /></li>
										<li><input type="reset" value="Clear" /></li>
									</ul>
								</form>
							</section>
							<section class="split">
								<section>
									<div class="contact-method">
										<span class="icon solid alt fa-envelope"></span>
										<h3>Email</h3>
										<a href="#">jinkunh@wku.edu.cn</a>
									</div>
								</section>
								<section>
									<div class="contact-method">
										<span class="icon solid alt fa-phone"></span>
										<h3>Phone</h3>
										<span>10086</span>
									</div>
								</section>
								<section>
									<div class="contact-method">
										<span class="icon solid alt fa-home"></span>
										<h3>Address</h3>
										<span>STEM Building 1075<br />
										Morris Ave, Union<br />
										NJ 07083, United States 
										</span>
									</div>
								</section>
							</section>
						</div>
					</section>

				<!-- Footer -->
					<footer id="footer">
						<div class="inner">
							<ul class="copyright">
								<li>&copy; Untitled</li>
							</ul>
						</div>
					</footer>

			</div>

        <!-- 隐藏的截图生成区域 -->
        <div id="share-card-wrapper">
            <div id="share-card">
                <div class="share-image-container">
                    <!-- 这里会动态插入 Unity 的截图 -->
                    <img id="unity-screenshot-img" src="" alt="Unity Screenshot" />
                </div>
                <div class="share-info-container">
                    <h3>Fluid3D</h3>
                    <p>Scan to Visit</p>
                    <div id="qrcode-container"></div>
                    <p style="margin-top: 10px; font-size: 0.8em;">Powered by WebGPU</p>
                </div>
            </div>
        </div>

		<!-- Scripts -->
			<script src="assets/js/jquery.min.js"></script>
			<script src="assets/js/jquery.scrolly.min.js"></script>
			<script src="assets/js/jquery.scrollex.min.js"></script>
			<script src="assets/js/browser.min.js"></script>
			<script src="assets/js/breakpoints.min.js"></script>
			<script src="assets/js/util.js"></script>
			<script src="assets/js/main.js"></script>

            <!-- Unity Scripts -->
            <script>
                var canvas = document.querySelector("#unity-canvas");
          
                function unityShowBanner(msg, type) {
                  var warningBanner = document.querySelector("#unity-warning");
                  function updateBannerVisibility() {
                    warningBanner.style.display = warningBanner.children.length ? 'block' : 'none';
                  }
                  var div = document.createElement('div');
                  div.innerHTML = msg;
                  warningBanner.appendChild(div);
                  if (type == 'error') div.style = 'background: red; padding: 10px;';
                  else {
                    if (type == 'warning') div.style = 'background: yellow; padding: 10px;';
                    setTimeout(function() {
                      warningBanner.removeChild(div);
                      updateBannerVisibility();
                    }, 5000);
                  }
                  updateBannerVisibility();
                }
          
                // Corrected Path: Pointing to MathSurface/Build
                var buildUrl = "Fluid3D/Build";
                var loaderUrl = buildUrl + "/Build.loader.js";
                var config = {
                  arguments: [],
                  dataUrl: buildUrl + "/Build.data",
                  frameworkUrl: buildUrl + "/Build.framework.js",
                  codeUrl: buildUrl + "/Build.wasm",
                  streamingAssetsUrl: "Fluid3D/StreamingAssets", // Updated Path
                  companyName: "DefaultCompany",
                  productName: "Web-End Demonstration",
                  productVersion: "0.1",
                  showBanner: unityShowBanner,
                  // CRITICAL CHANGE: This allows the canvas to be captured by toDataURL()
                  webglContextAttributes: {
                      preserveDrawingBuffer: true
                  }
                };
          
                if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
                  var meta = document.createElement('meta');
                  meta.name = 'viewport';
                  meta.content = 'width=device-width, height=device-height, initial-scale=1.0, user-scalable=no, shrink-to-fit=yes';
                  document.getElementsByTagName('head')[0].appendChild(meta);
                  document.querySelector("#unity-container").className = "unity-mobile";
                  canvas.className = "unity-mobile";
                } else {
                  canvas.style.width = "960px";
                  canvas.style.height = "600px";
                }
          
                document.querySelector("#unity-loading-bar").style.display = "block";
          
                var script = document.createElement("script");
                script.src = loaderUrl;
                script.onload = () => {
                  createUnityInstance(canvas, config, (progress) => {
                    document.querySelector("#unity-progress-bar-full").style.width = 100 * progress + "%";
                        }).then((unityInstance) => {
                          document.querySelector("#unity-loading-bar").style.display = "none";
                          document.querySelector("#unity-fullscreen-button").onclick = () => {
                            unityInstance.SetFullscreen(1);
                          };
                        }).catch((message) => {
                          alert(message);
                        });
                      };
          
                document.body.appendChild(script);

                // === 截图与分享功能逻辑 ===
                document.getElementById('btn-share-screenshot').addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // 1. 获取 Unity Canvas 的图像数据
                    // 注意：config 中必须设置 preserveDrawingBuffer: true，否则这里会是黑屏
                    var unityCanvas = document.querySelector("#unity-canvas");
                    var dataURL = unityCanvas.toDataURL("image/png");
                    document.getElementById('unity-screenshot-img').src = dataURL;

                    // 2. 生成二维码
                    var qrContainer = document.getElementById("qrcode-container");
                    qrContainer.innerHTML = ""; // 清空旧的二维码
                    var currentUrl = window.location.href;
                    
                    new QRCode(qrContainer, {
                        text: currentUrl,
                        width: 150,
                        height: 150,
                        colorDark : "#000000",
                        colorLight : "#ffffff",
                        correctLevel : QRCode.CorrectLevel.H
                    });

                    // 3. 使用 html2canvas 将隐藏的 #share-card 渲染为图片并下载
                    var shareCard = document.getElementById("share-card");
                    
                    // 给一点时间让图片和二维码渲染完成
                    setTimeout(() => {
                        html2canvas(shareCard, {
                            backgroundColor: null, // 保持透明或CSS背景
                            scale: 1 // 可以提高缩放比例以获得更高清晰度
                        }).then(canvas => {
                            // 创建下载链接
                            var link = document.createElement('a');
                            link.download = 'Share.png';
                            link.href = canvas.toDataURL("image/png");
                            link.click();
                        });
                    }, 100);
                });
              </script>

	</body>
</html>